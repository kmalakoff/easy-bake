// Generated by CoffeeScript 1.3.3
var args, page, page_filename, start, timeout;

args = phantom.args;

if (args.length < 1 || args.length > 2) {
  console.log("Usage: " + phantom.scriptName + " <URL> <timeout>");
  phantom.exit(1);
}

page_filename = args[0];

timeout = parseInt(args[1], 10) || 60000;

start = Date.now();

page = require('webpage').create();

page.onConsoleMessage = function(msg) {
  if (msg.indexOf('warning') !== 0) {
    return console.log(msg);
  }
};

page.open(page_filename, function(status) {
  var interval;
  if (status !== 'success') {
    console.error("Unable to access network");
    return phantom.exit(1);
  } else {
    return interval = setInterval((function() {
      var stats;
      if (Date.now() > start + timeout) {
        console.error("Tests timed out");
        return phantom.exit(124);
      } else {
        stats = page.evaluate(function() {
          if (QUnit.config.queue.length === 0) {
            return QUnit.config.stats;
          }
        });
        if (!stats) {
          return;
        }
        clearInterval(interval);
        if (stats.bad > 0) {
          return phantom.exit(1);
        } else {
          return phantom.exit();
        }
      }
    }), 500);
  }
});
